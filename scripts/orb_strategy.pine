// ORB (Opening Range Breakout) Strategy with RSI Filter
// For SPY 5-minute chart — sends webhook alerts to DayTrader backend
//
// Optimized params (30-day backtest): +$3,080, 58 trades, 55% WR, 3.83 PF
//   ORB 15min, RSI 9 filter, delta 0.5, SL 16%, PT 30%, trail 10%, hold 30m
//
// Setup:
//   1. Add this indicator to a SPY 5-minute chart on TradingView
//   2. Create an alert → Condition = "ORB Strategy" → any alert()
//   3. Notifications → Webhook URL = https://your-server/api/webhook
//   4. Alert message: leave blank (the script sets the alert_message)

//@version=6
indicator("ORB Strategy + RSI Filter", overlay=true, max_bars_back=500)

// ── Inputs ──────────────────────────────────────────────────────────

webhookSecret   = input.string("YoGnOKFZBJBd4ZuxXrLVrHu2bY8J8BfE", "Webhook Secret", tooltip="Must match WEBHOOK_SECRET in your .env")
orbMinutes      = input.int(15, "ORB Window (minutes)", minval=5, maxval=60)
rsiPeriod       = input.int(9, "RSI Period", minval=2, maxval=50)
rsiOB           = input.float(70.0, "RSI Overbought", minval=50, maxval=95)
rsiOS           = input.float(30.0, "RSI Oversold", minval=5, maxval=50)

// Trading windows (Eastern Time)
morningStart    = input.session("0945-1115", "Morning Window")
afternoonOn     = input.bool(true, "Afternoon Window Enabled")
afternoonStart  = input.session("1245-1450", "Afternoon Window")

// ── Time helpers ────────────────────────────────────────────────────

// TradingView bar times are in exchange timezone (ET for SPY)
barHour   = hour(time)
barMinute = minute(time)
barMins   = barHour * 60 + barMinute  // minutes since midnight

marketOpen   = 9 * 60 + 30   // 09:30 ET
orbEnd       = marketOpen + orbMinutes

morningWinStart = 9 * 60 + 45
morningWinEnd   = 11 * 60 + 15
afternoonWinStart = 12 * 60 + 45
afternoonWinEnd   = 14 * 60 + 50

isNewDay = ta.change(time("D")) != 0

inMorningWindow    = barMins >= morningWinStart and barMins <= morningWinEnd
inAfternoonWindow  = afternoonOn and barMins >= afternoonWinStart and barMins <= afternoonWinEnd
inTradingWindow    = inMorningWindow or inAfternoonWindow

// ── Opening Range Calculation ───────────────────────────────────────

var float orbHigh = na
var float orbLow  = na
var bool  orbSet  = false

if isNewDay
    orbHigh := na
    orbLow  := na
    orbSet  := false

// Accumulate ORB during the opening range window
inORBWindow = barMins >= marketOpen and barMins < orbEnd

if inORBWindow
    orbHigh := na(orbHigh) ? high : math.max(orbHigh, high)
    orbLow  := na(orbLow)  ? low  : math.min(orbLow, low)
    orbSet  := false

// Mark ORB as set once we exit the window
if barMins >= orbEnd and not orbSet and not na(orbHigh)
    orbSet := true

// ── RSI ─────────────────────────────────────────────────────────────

rsiVal = ta.rsi(close, rsiPeriod)

// ── Signal Detection ────────────────────────────────────────────────

breakoutUp   = orbSet and not na(orbHigh) and close[1] <= orbHigh and close > orbHigh
breakoutDown = orbSet and not na(orbLow)  and close[1] >= orbLow  and close < orbLow

// RSI filter: block signals that disagree
rsiAllowCall = na(rsiVal) or rsiVal <= rsiOB   // don't buy calls when overbought
rsiAllowPut  = na(rsiVal) or rsiVal >= rsiOS   // don't buy puts when oversold

callSignal = breakoutUp   and rsiAllowCall and inTradingWindow
putSignal  = breakoutDown and rsiAllowPut  and inTradingWindow

// ── Prevent duplicate alerts (one signal per direction per day) ─────

var bool calledToday = false
var bool puttedToday = false

if isNewDay
    calledToday := false
    puttedToday := false

callFire = callSignal and not calledToday
putFire  = putSignal  and not puttedToday

if callFire
    calledToday := true
if putFire
    puttedToday := true

// ── Webhook Alerts ──────────────────────────────────────────────────

// TradingView alert messages — these become the webhook POST body
callMsg = '{"ticker":"SPY","action":"BUY_CALL","secret":"' + webhookSecret + '","price":' + str.tostring(close) + ',"comment":"ORB breakout above ' + str.tostring(orbHigh, "#.##") + ', RSI ' + str.tostring(rsiVal, "#.#") + '"}'
putMsg  = '{"ticker":"SPY","action":"BUY_PUT","secret":"' + webhookSecret + '","price":' + str.tostring(close) + ',"comment":"ORB breakdown below ' + str.tostring(orbLow, "#.##") + ', RSI ' + str.tostring(rsiVal, "#.#") + '"}'

if callFire
    alert(callMsg, alert.freq_once_per_bar)
if putFire
    alert(putMsg, alert.freq_once_per_bar)

// ── Plotting ────────────────────────────────────────────────────────

// ORB levels (only after ORB window closes)
orbColor = color.new(color.orange, 50)
plot(orbSet ? orbHigh : na, "ORB High", orbColor, 2, plot.style_linebr)
plot(orbSet ? orbLow  : na, "ORB Low",  orbColor, 2, plot.style_linebr)

// Fill between ORB levels
p1 = plot(orbSet ? orbHigh : na, display=display.none)
p2 = plot(orbSet ? orbLow  : na, display=display.none)
fill(p1, p2, color=color.new(color.orange, 90))

// Signal markers
plotshape(callFire, "CALL Signal", shape.triangleup,   location.belowbar, color.green, size=size.small)
plotshape(putFire,  "PUT Signal",  shape.triangledown, location.abovebar, color.red,   size=size.small)

// RSI reference line (in separate pane if needed)
// plot(rsiVal, "RSI", color.purple)

// ── Info Table ──────────────────────────────────────────────────────

var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.gray, 85))

if barstate.islast
    table.cell(infoTable, 0, 0, "ORB High",  text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, na(orbHigh) ? "—" : str.tostring(orbHigh, "#.##"), text_color=color.green, text_size=size.small)
    table.cell(infoTable, 0, 1, "ORB Low",   text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, na(orbLow) ? "—" : str.tostring(orbLow, "#.##"), text_color=color.red, text_size=size.small)
    table.cell(infoTable, 0, 2, "RSI(" + str.tostring(rsiPeriod) + ")", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, na(rsiVal) ? "—" : str.tostring(rsiVal, "#.#"), text_color=color.purple, text_size=size.small)
    table.cell(infoTable, 0, 3, "Window",    text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, inTradingWindow ? "ACTIVE" : "CLOSED", text_color=inTradingWindow ? color.green : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 4, "ORB Set",   text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, orbSet ? "YES" : "NO", text_color=orbSet ? color.green : color.gray, text_size=size.small)
